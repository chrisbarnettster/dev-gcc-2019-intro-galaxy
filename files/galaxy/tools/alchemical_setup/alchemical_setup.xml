<tool id="alchemical_setup" name="Alchemical Setup" version="1.0.0">
    <description>Setup alchemical free energy calculations</description> 
    <requirements>
         <requirement type="package" version="1.0.0">protocaller</requirement>
         <requirement type="package" version="2019.1">gromacs</requirement>
    </requirements>
    <command detect_errors="exit_code">
<![CDATA[
     python '$protocaller_inp' &>> '$report' 
    ]]></command>
    <configfiles>
         <configfile name="protocaller_inp">
import ProtoCaller
from ProtoCaller.Utils.fileio import Dir
from ProtoCaller.Ensemble import Ligand, Protein, Ensemble

with Dir("RESULTS", overwrite=True):
    protein = Protein('$pdbin', ligand_ref='$refin', workdir="Protein")
#if $meth == "yes":
    for residue in protein.pdb_obj.modified_residues:
        residue.resName = "MET"
        for atom in residue:
            if atom.name == "SE":
                atom.name = "SD"
                atom.element = "S"
#end if
#if $atloc == "yes":
    for chain in protein.pdb_obj:
        for residue in chain:
            atoms_to_purge = [x for x in residue if x.altLoc == "B"]
            residue.purgeAtoms(atoms_to_purge, "discard")
    protein.pdb_obj.writePDB()
#end if

    lig1 = Ligand('$lig1', name="lig1", workdir="Ligands")
    lig2 = Ligand('$lig2', name="lig2", workdir="Ligands")
    morphs = [[lig1, lig2], [lig2, lig1]]
    system = Ensemble("GROMACS", protein=protein, morphs=morphs,
                      box_length_complex='$box_d', box_length_morph='$box_l', protein_ff='$pro_ff', ligand_ff='$lig_ff',
                      ion_conc='$ion_c', workdir=protein.workdir.path)
    system.protein.filter(ligands=None, waters="all")
    system.protein.prepare()
    system.prepareComplexes()
         </configfile> 
    </configfiles>    
    <inputs>
        <param name="pdbin" type="text" value="181L" label="PDBID"/>
        <param name="pro_ff" type="select" label="Protein force field">
            <option value="ff14SB" selected="true">ff14SB</option>
            <option value="ff99SB">ff99SB</option>
            <option value="ff15ipq">ff15ipq</option>
            <option value="fb15">fb15</option>
            <option value="ff03.r1">ff03.r1</option>
            <option value="ff03ua">ff03ua</option>
        </param>
        <param name="meth" type="select" label="Change the selenomethionine residues to methionine">
            <option value="yes" selected="true">Yes</option>
            <option value="no">No</option>
        </param>
        <param name="atloc" type="select" label="delete any atoms with alternate locations (altLoc B)">
            <option value="yes" selected="true">Yes</option>
            <option value="no">no</option>
        </param>
        <param name="refin" type="integer"  value="400" label="Ligand Referance"/>
        <param name="lig1" type="text" value="C1=CC=CC=C1" label="Ligand 1 SMILE or InChI string"/>
        <param name="lig2" type="text"  value="CC1=CC=CC=C1C" label="Ligand 2 SMILE or InChI string"/>
        <param name="lig_ff" type="select" label="Ligand force field">
            <option value="gaff">gaff</option>
            <option value="gaff2" selected="true">gaff2</option>
        </param>
        <param name="box_d" type="float" label="Box dimensions in nanometers for protien-ligand system (nm)" value="7.0" min="0.0" max="25.0"/>
        <param name="box_l" type="float" label="Box dimensions in nanometers for ligand morph (nm)" value="4.0" min="0.0" max="25.0"/>
        <param name="ion_c" type="text" value="0.154" label="Concentration of the ions (mol/L)"/>
    </inputs>
    <outputs>
      <data name="report" format="txt" label="Report"/> 
      <data name="progro1" format="gro" from_work_dir="./RESULTS/Protein/lig1~lig2/complex_final.gro" label="Lig1 to Lig2 In Protein Structure"/>
      <data name="protop1" format="txt" from_work_dir="./RESULTS/Protein/lig1~lig2/complex_final.top" label="Lig1 to Lig2 In Protein Topology"/>  
      <data name="watgro1" format="gro" from_work_dir="./RESULTS/Protein/lig1~lig2/morph.gro"  label="Lig1 to Lig2 In Water Structure"/> 
      <data name="wattop1" format="txt" from_work_dir="./RESULTS/Protein/lig1~lig2/morph.top"  label="Lig1 to Lig2 In Water Topology"/> 
      <data name="progro2" format="gro" from_work_dir="./RESULTS/Protein/lig2~lig1/complex_final.gro" label="Lig2 to Lig1 In Protein Structure"/>
      <data name="protop2" format="txt" from_work_dir="./RESULTS/Protein/lig2~lig1/complex_final.top" label="Lig2 to Lig1 In Protein Topology"/>  
      <data name="watgro2" format="gro" from_work_dir="./RESULTS/Protein/lig2~lig1/morph.gro"  label="Lig2 to Lig1 In Water Structure"/> 
      <data name="wattop2" format="txt" from_work_dir="./RESULTS/Protein/lig2~lig1/morph.top"  label="Lig2 to Lig1 In Water Topology"/>     
    </outputs>

    <help><![CDATA[   
.. class:: infomark
 
**What it does**
        

This tool can setup alchemical simulations. 


_____


.. class:: infomark

**Input**

       - PDBID - can be obtained from https://www.rcsb.org/
       - Residue ID of the ligand to map the ligands
       - SMILE strings of ligands

_____

       
.. class:: infomark

**Output**

       - Report
       - Gromacs .GRO and .TOP files for the protein ligand system in water and ligands in water setups.

_____

       
.. class:: infomark

**Note**

The time to run this tool will depending on the size of the ligands. 
Be patient !!

If the SMILE strings does not work try InChI strings.
Cnversion can be done here http://www.cheminfo.org/Chemistry/Cheminformatics/FormatConverter/index.html

    ]]></help>
    <citations>
      <citation type="doi">10.1016/j.softx.2015.06.001</citation>
    </citations>
</tool>
